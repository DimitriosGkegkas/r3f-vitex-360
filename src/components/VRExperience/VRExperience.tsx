import React, { useState, useEffect } from 'react';
import { XRStore } from '@react-three/xr';
import './VRExperience.css';

// Custom VR Button Component
export const CustomVRButton: React.FC<{ xrStore: XRStore }> = ({ xrStore }) => {
    const [isVRSupported, setIsVRSupported] = useState(false);
    const [isInVR, setIsInVR] = useState(false);

    useEffect(() => {
        // Check if WebXR is supported
        if ('xr' in navigator) {
            navigator.xr?.isSessionSupported('immersive-vr').then((supported) => {
                setIsVRSupported(supported);
            });
        }
    }, []);

    const handleVRButtonClick = async () => {
        if (isVRSupported && !isInVR) {
            try {
                console.log('🥽 Attempting to enter VR...');
                await xrStore.enterVR();
                setIsInVR(true);
                console.log('✅ VR session started successfully');
            } catch (error) {
                console.error('❌ Failed to enter VR:', error);
                setIsInVR(false);
                // Show user-friendly error message
                alert('Failed to enter VR mode. Please ensure your VR headset is connected and try again.');
            }
        } else if (isInVR) {
            try {
                console.log('🖥️ Exiting VR...');
                await xrStore.getState().session.end();
                setIsInVR(false);
                console.log('✅ VR session ended');
            } catch (error) {
                console.error('❌ Failed to exit VR:', error);
            }
        }
    };

    if (!isVRSupported) {
        return (
            <div className="vr-button-disabled" role="button" tabIndex={-1}>
                <div className="vr-button-content">
                    <div className="vr-button-icon">
                        <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16.5 0.75H1.5C1.16848 0.75 0.850537 0.881696 0.616116 1.11612C0.381696 1.35054 0.25 1.66848 0.25 2V12C0.25 12.3315 0.381696 12.6495 0.616116 12.8839C0.850537 13.1183 1.16848 13.25 1.5 13.25H6.5C6.5821 13.2501 6.66341 13.234 6.73928 13.2026C6.81515 13.1712 6.8841 13.1252 6.94219 13.0672L9 11.0086L11.0578 13.0672C11.1159 13.1252 11.1848 13.1712 11.2607 13.2026C11.3366 13.234 11.4179 13.2501 11.5 13.25H16.5C16.8315 13.25 17.1495 13.1183 17.3839 12.8839C17.6183 12.6495 17.75 12.3315 17.75 12V2C17.75 1.66848 17.6183 1.35054 17.3839 1.11612C17.1495 0.881696 16.8315 0.75 16.5 0.75ZM16.5 12H11.7586L9.88359 10.125C9.6492 9.89076 9.33138 9.75917 9 9.75917C8.66862 9.75917 8.3508 9.89076 8.11641 10.125L6.24141 12H1.5V2H16.5V12ZM5.25 9.5C5.74445 9.5 6.2278 9.35338 6.63893 9.07867C7.05005 8.80397 7.37048 8.41352 7.5597 7.95671C7.74892 7.49989 7.79843 6.99723 7.70196 6.51227C7.6055 6.02732 7.3674 5.58186 7.01777 5.23223C6.66814 4.8826 6.22268 4.6445 5.73773 4.54804C5.25277 4.45157 4.75011 4.50108 4.29329 4.6903C3.83648 4.87952 3.44603 5.19995 3.17133 5.61107C2.89662 6.0222 2.75 6.50555 2.75 7C2.75 7.66304 3.01339 8.29893 3.48223 8.76777C3.95107 9.23661 4.58696 9.5 5.25 9.5ZM5.25 5.75C5.49723 5.75 5.7389 5.82331 5.94446 5.96066C6.15002 6.09801 6.31024 6.29324 6.40485 6.52165C6.49946 6.75005 6.52421 7.00139 6.47598 7.24386C6.42775 7.48634 6.3087 7.70907 6.13388 7.88388C5.95907 8.0587 5.73634 8.17775 5.49386 8.22598C5.25139 8.27421 5.00005 8.24946 4.77165 8.15485C4.54324 8.06024 4.34801 7.90002 4.21066 7.69446C4.07331 7.4889 4 7.24723 4 7C4 6.66848 4.1317 6.35054 4.36612 6.11612C4.60054 5.8817 4.91848 5.75 5.25 5.75ZM12.75 9.5C13.2445 9.5 13.7278 9.35338 14.1389 9.07867C14.55 8.80397 14.8705 8.41352 15.0597 7.95671C15.2489 7.49989 15.2984 6.99723 15.202 6.51227C15.1055 6.02732 14.8674 5.58186 14.5178 5.23223C14.1681 4.8826 13.7227 4.6445 13.2377 4.54804C12.7528 4.45157 12.2501 4.50108 11.7933 4.6903C11.3365 4.87952 10.946 5.19995 10.6713 5.61107C10.3966 6.0222 10.25 6.50555 10.25 7C10.25 7.66304 10.5134 8.29893 10.9822 8.76777C11.4511 9.23661 12.087 9.5 12.75 9.5ZM12.75 5.75C12.9972 5.75 13.2389 5.82331 13.4445 5.96066C13.65 6.09801 13.8102 6.29324 13.9049 6.52165C13.9995 6.75005 14.0242 7.00139 13.976 7.24386C13.9278 7.48634 13.8087 7.70907 13.6339 7.88388C13.4591 8.0587 13.2363 8.17775 12.9939 8.22598C12.7514 8.27421 12.5001 8.24946 12.2716 8.15485C12.0432 8.06024 11.848 7.90002 11.7107 7.69446C11.5733 7.4889 11.5 7.24723 11.5 7C11.5 6.66848 11.6317 6.35054 11.8661 6.11612C12.1005 5.8817 12.4185 5.75 12.75 5.75Z" fill="#1A1A1A" />
                        </svg>

                    </div>
                    <div className="vr-button-text">VR Not Supported</div>
                </div>
            </div>
        );
    }

    return (
        <div
            className="vr-button"
            onClick={handleVRButtonClick}
            role="button"
            tabIndex={0}
            onKeyDown={(e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleVRButtonClick();
                }
            }}
        >
            <div className="vr-button-content">
                <div className="vr-button-icon">
                    <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16.5 0.75H1.5C1.16848 0.75 0.850537 0.881696 0.616116 1.11612C0.381696 1.35054 0.25 1.66848 0.25 2V12C0.25 12.3315 0.381696 12.6495 0.616116 12.8839C0.850537 13.1183 1.16848 13.25 1.5 13.25H6.5C6.5821 13.2501 6.66341 13.234 6.73928 13.2026C6.81515 13.1712 6.8841 13.1252 6.94219 13.0672L9 11.0086L11.0578 13.0672C11.1159 13.1252 11.1848 13.1712 11.2607 13.2026C11.3366 13.234 11.4179 13.2501 11.5 13.25H16.5C16.8315 13.25 17.1495 13.1183 17.3839 12.8839C17.6183 12.6495 17.75 12.3315 17.75 12V2C17.75 1.66848 17.6183 1.35054 17.3839 1.11612C17.1495 0.881696 16.8315 0.75 16.5 0.75ZM16.5 12H11.7586L9.88359 10.125C9.6492 9.89076 9.33138 9.75917 9 9.75917C8.66862 9.75917 8.3508 9.89076 8.11641 10.125L6.24141 12H1.5V2H16.5V12ZM5.25 9.5C5.74445 9.5 6.2278 9.35338 6.63893 9.07867C7.05005 8.80397 7.37048 8.41352 7.5597 7.95671C7.74892 7.49989 7.79843 6.99723 7.70196 6.51227C7.6055 6.02732 7.3674 5.58186 7.01777 5.23223C6.66814 4.8826 6.22268 4.6445 5.73773 4.54804C5.25277 4.45157 4.75011 4.50108 4.29329 4.6903C3.83648 4.87952 3.44603 5.19995 3.17133 5.61107C2.89662 6.0222 2.75 6.50555 2.75 7C2.75 7.66304 3.01339 8.29893 3.48223 8.76777C3.95107 9.23661 4.58696 9.5 5.25 9.5ZM5.25 5.75C5.49723 5.75 5.7389 5.82331 5.94446 5.96066C6.15002 6.09801 6.31024 6.29324 6.40485 6.52165C6.49946 6.75005 6.52421 7.00139 6.47598 7.24386C6.42775 7.48634 6.3087 7.70907 6.13388 7.88388C5.95907 8.0587 5.73634 8.17775 5.49386 8.22598C5.25139 8.27421 5.00005 8.24946 4.77165 8.15485C4.54324 8.06024 4.34801 7.90002 4.21066 7.69446C4.07331 7.4889 4 7.24723 4 7C4 6.66848 4.1317 6.35054 4.36612 6.11612C4.60054 5.8817 4.91848 5.75 5.25 5.75ZM12.75 9.5C13.2445 9.5 13.7278 9.35338 14.1389 9.07867C14.55 8.80397 14.8705 8.41352 15.0597 7.95671C15.2489 7.49989 15.2984 6.99723 15.202 6.51227C15.1055 6.02732 14.8674 5.58186 14.5178 5.23223C14.1681 4.8826 13.7227 4.6445 13.2377 4.54804C12.7528 4.45157 12.2501 4.50108 11.7933 4.6903C11.3365 4.87952 10.946 5.19995 10.6713 5.61107C10.3966 6.0222 10.25 6.50555 10.25 7C10.25 7.66304 10.5134 8.29893 10.9822 8.76777C11.4511 9.23661 12.087 9.5 12.75 9.5ZM12.75 5.75C12.9972 5.75 13.2389 5.82331 13.4445 5.96066C13.65 6.09801 13.8102 6.29324 13.9049 6.52165C13.9995 6.75005 14.0242 7.00139 13.976 7.24386C13.9278 7.48634 13.8087 7.70907 13.6339 7.88388C13.4591 8.0587 13.2363 8.17775 12.9939 8.22598C12.7514 8.27421 12.5001 8.24946 12.2716 8.15485C12.0432 8.06024 11.848 7.90002 11.7107 7.69446C11.5733 7.4889 11.5 7.24723 11.5 7C11.5 6.66848 11.6317 6.35054 11.8661 6.11612C12.1005 5.8817 12.4185 5.75 12.75 5.75Z" fill="#1A1A1A" />
                    </svg>

                </div>
                <div className="vr-button-text">
                    {isInVR ? 'Έξοδος από VR' : 'Μετάβαση σε VR'}
                </div>
            </div>
        </div>
    );
};

